<div class="container" style="padding-top: 100px">
  <div class="col-md-6 col-md-offset-3">
    <div class="panel panel-default">
      <!-- Default panel contents -->
      <div class="panel-heading">OpenManna Donations</div>
      <div class="panel-body">
        <p>
          Thank you for taking interest in my web application 'OpenManna'. What started out as merely a coding exercise, it has transformed into an useful, functioning servcie for over 150 users and counting. I am thankful that OpenManna can be a part of your every day life. 
        </p>
      </div>

      <!-- List group -->
      <ul class="list-group" style="text-align: cneter">
        <li class="list-group-item donate_price">
        <div class="btn btn-success btn-amount">$5</div>
        </li>
        <li class="list-group-item donate_price">
        <div class="btn btn-primary btn-amount">$10</div>
        </li>
        <li class="list-group-item donate_price">
        <div class="btn btn-info btn-amount">$20</div>
        </li>
      </ul>
      <div class="panel-footer">
        <%= form_tag donations_path do %>
          <div id="error_explanation">
            <% if flash[:error].present? %>
              <p><%= flash[:error] %></p>
            <% end %>
          </div>
          <article style="text-align: center">
          <div class="row">
            <div class="col-md-8 col-xs-6">
              <%= label_tag(:amount, 'Amount:') %>
              <%= text_field_tag (:amount), nil, placeholder: 'Other Amount', class: 'amount_field' %>
              <%= hidden_field_tag(:stripeToken) %>
            </div>
            <div class="col-md-4 col-xs-6">
              <div class="btn btn-default" id='donateButton'>Give</div>
            </div>
          </div>
          </article>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script src="https://checkout.stripe.com/checkout.js"></script>

<script>
  var handler = StripeCheckout.configure({
    key: '<%= Rails.configuration.stripe[:publishable_key] %>',
    locale: 'auto',
    name: 'Sand Castles United',
    description: 'One-time donation',
    token: function(token) {
      $('input#stripeToken').val(token.id);
      $('form').submit();
    }
  });

  // Validations
  $('#donateButton').on('click', function(e) {
    e.preventDefault();

    $('#error_explanation').html('');

    var amount = $('input#amount').val();
    amount = amount.replace(/\$/g, '').replace(/\,/g, '')

    amount = parseFloat(amount);

    if (isNaN(amount)) {
      $('#error_explanation').html('<p>Please enter a valid amount in USD ($).</p>');
    }
    else if (amount < 5.00) {
      $('#error_explanation').html('<p>Donation amount must be at least $5.</p>');
    }
    else {
      amount = amount * 100; // Needs to be an integer!
      handler.open({
        amount: Math.round(amount)
      })
    }
  });

  // Close Checkout on page navigation
  $(window).on('popstate', function() {
    handler.close();
  });
</script>
